==========================================
Bias correction and downscaling algorithms
==========================================

`xarray` data structures allow for relatively straightforward implementations of simple bias-correction and downscaling algorithms documented in :ref:`downscaling-api`. Each algorithm is split into `train` and `predict` components. The `train` function will compare two DataArrays `x` and `y`, and return a `Dataset` object storing the *transfer* information allowing to go from `x` to `y`. This dataset can then be used as an input to the `predict` function to apply this information to `x`. `x` could be the same `DataArray` used for training, or another `DataArray` with similar characteristics.

For example, given a daily time series of observations `obs`, a model simulation over the observational period `hist` and a model simulation over a future period `fut`, we would apply a bias-correction method such a detrended quantile mapping (DQM) as::

  from xclim.downscaling import dqm
  tf = dqm.train(hist, obs)
  scenario = dqm.predict(fut, tf)

Each method can either be applied additively or multiplicatively. Also, each method can be applied independently on different time groupings (monthly, seasonally) or according to the day of the year and a rolling window width.

When transfer factors are applied in prediction, they can be interpolated according to the time grouping. This helps avoid discontinuities in correction factors at the beginning of each season or month and is computationaly cheaper than computing correction factors for each day of the year.


Application in multi-variate settings
=====================================

There are no multivariate algorithm implemented yet, and when applying uni-variate correction methods to multiple variables, some strategies are recommended to avoid introducing unrealistic artifacts in corrected outputs.

Minimum and maximum temperature
-------------------------------

When correcting both minimum and maximum temperature, correction factors sometimes yields minimum temperatures larger than maximum temperature on the same day, which of course, is non-sensical. One way to avoid this is to first correct maximum temperature using an additive correction, then correct the diurnal temperature range (DTR) using a multiplicative correction, and then determine minimum temperature by subtracting DTR from the maximum temperature ([Thrasher]_, [Agbazo]_)

Relative and specific humidity
------------------------------

When correcting both relative and specific humidity, we want to preserve the relationship between both. To do this, [Grenier]_ suggests to first correct the relative humidity using a multiplicative factor, ensure values are within 0-100%, then applu an additive correction factor to the surface pressure before estimating the specific humidity from thermodynamic relationships.

Radiation and precipitation
---------------------------

In theory, short wave radiation should be capped when precipitation is not zero, but there is as of yet no mechanism proposed to do that, see [Hoffman]_.


References
==========

.. [Agbazo] Agbazo, M. N., & Grenier, P. (2019). Characterizing and avoiding physical inconsistency generated by the application of univariate quantile mapping on daily minimum and maximum temperatures over Hudson Bay. International Journal of Climatology, joc.6432. https://doi.org/10.1002/joc.6432
.. [Grenier] Grenier, P. (2018). Two Types of Physical Inconsistency to Avoid with Univariate Quantile Mapping: A Case Study over North America Concerning Relative Humidity and Its Parent Variables. Journal of Applied Meteorology and Climatology, 57(2), 347–364. https://doi.org/10.1175/JAMC-D-17-0177.1
.. [Hoffman] Hoffmann, H., & Rath, T. (2012). Meteorologically consistent bias correction of climate time series for agricultural models. Theoretical and Applied Climatology, 110(1–2), 129–141. https://doi.org/10.1007/s00704-012-0618-x
.. [Thrasher] Thrasher, B., Maurer, E. P., McKellar, C., & Duffy, P. B. (2012). Technical Note: Bias correcting climate model simulated daily temperature extremes with quantile mapping. Hydrology and Earth System Sciences, 16(9), 3309–3314. https://doi.org/10.5194/hess-16-3309-2012
